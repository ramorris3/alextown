var app=angular.module("GameApp",[]);app.service("AssetService",["$http","LoaderService","MessageService",function($http,LoaderService,MessageService){function init(){$http.get("../api/assets").success(function(data){allAssets=data.allAssetData,LoaderService.assets=!0,LoaderService.loadHandler()}).error(function(data){console.log("ERROR"+JSON.stringify(data))})}var self=this,allAssets={};self.getAllAssets=function(){return allAssets},init(),self.getBullets=function(){return allAssets.Bullets},self.getEnemies=function(){return allAssets.Enemies},self.getBackgrounds=function(){return allAssets.Backgrounds},self.saveAsset=function(spriteData,imgSrc){var assetType=allAssets[spriteData.type];return assetType.hasOwnProperty(spriteData.name)&&!confirm('There is already an asset of type "'+spriteData.type+'" named "'+spriteData.name+'."  Do you want to overwrite it?')?void MessageService.setFlashMessage("Asset was not saved.",!0):void $http.post("../api/save/img",{img:imgSrc,name:spriteData.name}).success(function(data){spriteData.key=data.key,spriteData.src=data.src,$http.post("../api/save/asset",spriteData).success(function(data){MessageService.setFlashMessage(data.message),allAssets=data.allAssetData}).error(function(data){MessageService.setFlashMessage(data.message,!0)})}).error(function(data){MessageService.setFlashMessage(data.message,!0)})},self.preloadAllAssets=function(game){for(var category in allAssets)if(allAssets.hasOwnProperty(category)){var assets=allAssets[category];for(var asset in assets)if(assets.hasOwnProperty(asset)){var obj=assets[asset];game.load.spritesheet(obj.key,obj.src,obj.width,obj.height)}}}}]),app.service("BossService",["DamageService","WeaponService",function(DamageService,WeaponService){var self=this,bosses={};self.getBosses=function(){return bosses},self.preloadBossAssets=function(game){game.load.spritesheet("mini-snake","../assets/mini-snake.png",80,47),game.load.spritesheet("biscione","../assets/biscione.png",328,320),console.log("game.loaded spritesheet for boss")},self.Biscione=function(game,x,y){this.game=game,Phaser.Sprite.call(this,this.game,x,y,"biscione"),this.anchor.setTo(.5,.5),this.alive=!0,this.animations.add("move"),this.animations.play("move",10,!0),this.game.physics.enable(this,Phaser.Physics.ARCADE),this.ySpeed=2,this.invincible=!1,this.flashing=!1,this.flashTimer=0,this.health=40,this.damage=5,this.game.add.existing(this)},self.Biscione.prototype=Object.create(Phaser.Sprite.prototype),self.Biscione.prototype.constructor=self.Biscione,self.Biscione.prototype.update=function(){DamageService.flash(this),this.y+=this.ySpeed,(this.y>=this.game.height-this.height/2||this.y<=this.height/2)&&(this.ySpeed*=-1)}}]),app.service("DamageService",function(){var self=this;self.takeDamage=function(sprite,damage,isPlayer){var game=sprite.game;if(!sprite.invincible){if(sprite.health-=damage,game.damageNums){var dmgText=game.damageNums.getFirstDead();dmgText&&(dmgText.revive(),dmgText.text=damage,dmgText.outOfBoundsKill=!0,dmgText.reset(sprite.x,sprite.y),dmgText.alpha=1,dmgText.grav=-.1,dmgText.ydx=3.5,dmgText.xdx=1.5*Math.random(),Math.random()>=.5&&(dmgText.xdx*=-1),dmgText.update=function(){dmgText.x=dmgText.x+dmgText.xdx,dmgText.y-=dmgText.ydx,dmgText.ydx+=dmgText.grav,dmgText.alpha-=.02,dmgText.alpha<=0&&dmgText.kill()})}if(sprite.health<=0){var deathSpr=game.deathAnimations.getFirstDead();if(deathSpr&&(deathSpr.revive(),deathSpr.checkWorldBounds=!0,deathSpr.outOfBoundsKill=!0,deathSpr.reset(sprite.x,sprite.y),deathSpr.body.velocity.x=-50,deathSpr.animations.play("die",10,!1,!0)),sprite.pendingDestroy=!0,isPlayer){var fadeout=game.add.tween(game.world).to({alpha:0},2e3,"Linear",!0,0);fadeout.onComplete.add(function(){game.state.start("lose")})}}isPlayer&&(sprite.invincible=!0,game.time.events.add(350,function(){sprite.invincible=!1},sprite)),sprite.flashing=!0,game.time.events.add(500,function(){sprite.flashing=!1},sprite)}},self.flash=function(sprite){sprite.flashing?(sprite.flashTimer++,sprite.flashTimer%4===0?sprite.tint=8781824:sprite.tint=16777215):sprite.tint=16777215}}),app.service("EnemyService",["$http","$rootScope","DamageService","LoaderService","MessageService",function($http,$rootScope,DamageService,LoaderService,MessageService){function init(){$http.get("/api/enemies").success(function(data){allEnemies=data.allEnemyData,LoaderService.enemy=!0,LoaderService.loadHandler()}).error(function(data){MessageService.setFlashMessage(data.message,!0)})}var self=this,allEnemies={};self.getAllEnemies=function(){return allEnemies},self.getEnemy=function(key){return allEnemies[key]},init(),self.saveEnemy=function(enemyData,callback){if(allEnemies.hasOwnProperty(enemyData.name)){var overwrite=confirm('There is already an enemy named "'+enemyData.name+'."  Do you want to overwrite this enemy?');if(!overwrite)return void MessageService.setFlashMessage("Enemy was not saved.",!0)}$http.post("../api/save/enemies",enemyData).success(function(data){MessageService.setFlashMessage(data.message,!1),allEnemies=data.allEnemyData,callback&&callback()}).error(function(data){MessageService.setFlashMessage(data.message,!0)})},self.Enemy=function(game,x,y,data,playerSprite){this.game=game,this.data=data,Phaser.Sprite.call(this,this.game,x,y,data.spritesheet.key);var moveFrames=data.moveFrames.split(",");for(i=0;i<moveFrames.length;i++)moveFrames[i]=parseInt(moveFrames[i],10);var attackFrames=data.attackFrames.split(",");for(i=0;i<attackFrames.length;i++)attackFrames[i]=parseInt(attackFrames[i],10);this.animations.add("move",moveFrames,data.moveFps),this.animations.add("attack",attackFrames,data.attackFps);var shadow=this.game.add.sprite(0,32,"shadow");shadow.anchor.setTo(.5,.5),this.game.layers.shadows.add(shadow);var enemy=this;if(shadow.update=function(){this.x=enemy.x,this.y=enemy.y+enemy.height/2,enemy.health<=0&&(this.pendingDestroy=!0)},this.target=playerSprite,this.game.physics.enable(this,Phaser.Physics.ARCADE),this.anchor.setTo(.5,.5),this.health=data.health,this.damage=data.damage,this.moveSpeed=data.moveSpeed,this.invincible=!1,this.flashing=!1,this.flashTimer=0,this.movePattern=data.movePattern,this.attackPattern=data.attackPattern,"Charge"===this.attackPattern.key)this.getAttackStateInfo=this.getChargeStateInfo;else{if("Ranged"!==this.attackPattern.key)throw new Error("Attack-pattern key not recognized.");this.getAttackStateInfo=this.getRangedStateInfo}this.getAttackStateInfo().setup(),this.currentState=this.defaultState,this.game.add.existing(this)},self.Enemy.prototype=Object.create(Phaser.Sprite.prototype),self.Enemy.prototype.constructor=self.Enemy,self.Enemy.prototype.update=function(){DamageService.flash(this),this.currentState(),this.x<-this.width&&(this.pendingDestroy=!0)},self.Enemy.prototype.getChargeStateInfo=function(){var sprite=this;return{setup:function(){sprite.cooldown=sprite.attackPattern.cooldown,sprite.cooldownClock=0,sprite.chargeSpeed=sprite.attackPattern.chargeSpeed,sprite.chargeDuration=sprite.attackPattern.duration,sprite.chargeClock=0,sprite.chargeRange=sprite.attackPattern.range},startAttack:function(){sprite.cooldownClock&&sprite.cooldownClock--;var dist=sprite.game.math.distance(sprite.x,sprite.y,sprite.target.x,sprite.target.y);return dist<sprite.chargeRange&&!sprite.cooldownClock?(sprite.cooldownClock=sprite.cooldown,sprite.chargeClock=sprite.chargeDuration,sprite.chargeRotation=sprite.game.math.angleBetween(sprite.x,sprite.y,sprite.target.x,sprite.target.y),!0):!1},attackState:function(){sprite.chargeClock?(sprite.chargeClock--,sprite.animations.play("attack"),sprite.body.velocity.setTo(Math.cos(sprite.chargeRotation)*sprite.chargeSpeed,Math.sin(sprite.chargeRotation)*sprite.chargeSpeed),sprite.right>sprite.game.width&&(sprite.body.velocity.setTo(0,0),sprite.x=sprite.game.width-sprite.offsetX,sprite.chargeClock=0),sprite.bottom>sprite.game.height?(sprite.body.velocity.setTo(0,0),sprite.y=sprite.game.height-sprite.offsetY,sprite.chargeClock=0):sprite.top<0&&(sprite.body.velocity.setTo(0,0),sprite.y=sprite.offsetY,sprite.chargeClock=0)):sprite.currentState=sprite.defaultState}}},self.Enemy.prototype.getRangedStateInfo=function(){var sprite=this;return{setup:function(){sprite.cooldown=sprite.attackPattern.cooldown,sprite.cooldownClock=0,sprite.bullets=sprite.game.add.group();for(var i=0;30>i;i++){var bullet=sprite.game.add.sprite(0,0,sprite.attackPattern.bullet.key);bullet.anchor.setTo(.5,.5),bullet.outOfBoundsKill=!0,sprite.game.physics.enable(bullet,Phaser.Physics.ARCADE),bullet.bulletSpeed=sprite.attackPattern.bulletSpeed,bullet.damage=sprite.damage,bullet.animations.add("fly"),bullet.kill(),sprite.bullets.add(bullet)}sprite.game.allEnemyBullets.add(sprite.bullets),sprite.fireBullet=function(){sprite.cooldownClock=sprite.cooldown;var bullet=sprite.bullets.getFirstDead();bullet&&(bullet.revive(),bullet.checkWorldBounds=!0,bullet.outOfBoundsKill=!0,bullet.reset(sprite.x,sprite.y),bullet.body.velocity.x=-bullet.bulletSpeed,bullet.animations.play("fly",10,!0))}},startAttack:function(){return sprite.cooldownClock?(sprite.cooldownClock--,!1):(sprite.fireBullet(),!0)},attackState:function(){sprite.move(),sprite.animations.play("attack"),sprite.animations.currentAnim.onComplete.add(function(){sprite.cooldownClock?sprite.currentState=sprite.defaultState:sprite.fireBullet()})}}},self.Enemy.prototype.defaultState=function(){this.move(),this.animations.play("move"),this.getAttackStateInfo().startAttack()&&(this.currentState=this.getAttackStateInfo().attackState)},self.Enemy.prototype.move=function(){if("Default"===this.movePattern)this.body.velocity.setTo(-this.moveSpeed,0);else{if("Follow"!==this.movePattern)throw new Error("Move-pattern key unrecognized");var distance=this.game.math.distance(this.x,this.y,this.target.x,this.target.y);if(150>distance||this.x>this.target.x){var rotation=this.game.math.angleBetween(this.x,this.y,this.target.x,this.target.y);distance<this.moveSpeed?this.body.velocity.setTo(Math.cos(rotation)*distance,Math.sin(rotation)*distance):this.body.velocity.setTo(Math.cos(rotation)*this.moveSpeed,Math.sin(rotation)*this.moveSpeed)}else this.body.velocity.setTo(-this.moveSpeed,0)}}}]),app.service("LevelService",["$http","LoaderService","MessageService",function($http,LoaderService,MessageService){function init(){$http.get("../api/stages").success(function(data){allLevels=data.allLevelData,LoaderService.level=!0,LoaderService.loadHandler()}).error(function(data){MessageService.setFlashMessage(data.message,!0)})}var allLevels,self=this;self.getAllLevels=function(){return allLevels},self.getLevel=function(num){return allLevels[num]},init(),self.saveLevel=function(levelData){$http.post("../api/save/stage",levelData).success(function(data){allLevels=data.allLevelData,MessageService.setFlashMessage(data.message,!1)}).error(function(data){MessageService.setFlashMessage(data.message,!0)})}}]),app.service("LoaderService",function(){function loaded(){return self.assets&&self.enemy&&self.level&&self.player}var self=this;self.assets=!1,self.enemy=!1,self.level=!1,self.player=!1,self.weapon=!1;var loaderFunctions=[];self.addLoaderFunction=function(callback){loaded()?callback():loaderFunctions.push(callback)},self.loadHandler=function(){if(loaded())for(var i=0;i<loaderFunctions.length;i++)loaderFunctions[i]()}}),app.service("MessageService",["$rootScope",function($rootScope){var self=this,colors={RED:"#E8130C",GREEN:"#00B20B"},flashMessage={visible:!1,message:"",color:colors.GREEN};self.setFlashMessage=function(message,isBad){flashMessage.message=message,flashMessage.color=colors.GREEN,isBad&&(flashMessage.color=colors.RED,message||(flashMessage.message="An unknown error occured.")),flashMessage.visible=!0,setTimeout(function(){$rootScope.$apply(function(){self.hideFlashMessage()})},3e3)},self.getFlashMessage=function(){return flashMessage},self.hideFlashMessage=function(){flashMessage.visible=!1}}]),app.service("PersistenceService",["LevelService","PlayerService","WeaponService",function(LevelService,PlayerService,WeaponService){var self=this;self.getPlayerData=function(){return PlayerService.getPlayer("Mage")};var currentWeapon={name:"Starting Dagger",description:"This old, chipped dagger doesn't look too intimidating.",rarity:"Common","class":"Mage",level:1,damageBoost:0,firePattern:"SingleBullet",spritesheet:{type:"Bullets",name:"dagger-right",width:64,height:22,key:"dagger-right",src:"../game/assets/rusty-dagger.png"}};self.getCurrentWeapon=function(){return currentWeapon},self.setCurrentWeapon=function(newWeapon){currentWeapon=newWeapon};var currentLevel=1;self.getCurrentLevel=function(game){for(var levelData=LevelService.getLevel(currentLevel);!levelData;){if(currentLevel>10)return game.state.start("win"),currentLevel=1,!1;currentLevel++,levelData=LevelService.getLevel(currentLevel)}return levelData},self.nextLevel=function(game){currentLevel++,self.getCurrentLevel(game)&&game.state.start("prelevel")}}]),app.service("PlayerService",["$http","DamageService","LoaderService","WeaponService",function($http,DamageService,LoaderService,WeaponService){function init(){$http.get("/api/players").success(function(data){allPlayers=data.allPlayerData,LoaderService.player=!0,LoaderService.loadHandler()}).error(function(data){MessageService.setFlashMessage(data.message,!0)})}var self=this,allPlayers={};self.getAllPlayers=function(){return allPlayers},self.getPlayer=function(key){return allPlayers[key]},init(),self.Player=function(game,x,y,data,weaponData){this.game=game,Phaser.Sprite.call(this,this.game,x,y,data.spritesheet.key),this.animations.add("move",data.moveFrames,data.moveFps);var shadow=this.game.add.sprite(0,32,"shadow");shadow.anchor.setTo(.5,.5),this.game.layers.shadows.add(shadow);var player=this;shadow.update=function(){this.x=player.x,this.y=player.y+player.height/2,player.health<=0&&(this.pendingDestroy=!0)},this.game.physics.enable(this,Phaser.Physics.ARCADE),this.body.collideWorldBounds=!0,this.anchor.setTo(.5,.5),this.body.drag.setTo(1450,1450),this.invincible=!1,this.flashing=!1,this.flashTimer=0,this.health=data.health,this.damage=data.damage,this.maxSpeed=data.moveSpeed,this.diagSpeed=this.maxSpeed/Math.sqrt(2),this.acceleration=1500,this.weaponData=weaponData,this.weapon=WeaponService.getFirePattern(this.weaponData.firePattern),this.weapon.create(this.game,this.weaponData),this.cursors=this.game.input.keyboard.createCursorKeys(),this.game.input.keyboard.addKeyCapture([Phaser.Keyboard.SPACEBAR]),this.game.add.existing(this)},self.Player.prototype=Object.create(Phaser.Sprite.prototype),self.Player.prototype.constructor=self.Player,self.Player.prototype.update=function(){DamageService.flash(this),this.move(),this.animations.play("move"),this.isAttacking()&&this.weapon.fire(this.game,this)},self.Player.prototype.move=function(){(this.cursors.left.isDown||this.cursors.right.isDown)&&(this.cursors.up.isDown||this.cursors.down.isDown)?this.body.maxVelocity.setTo(this.diagSpeed,this.diagSpeed):this.body.maxVelocity.setTo(this.maxSpeed,this.maxSpeed),this.cursors.left.isDown?this.body.acceleration.x=-this.acceleration:this.cursors.right.isDown?this.body.acceleration.x=this.acceleration:this.body.acceleration.x=0,this.cursors.up.isDown?this.body.acceleration.y=-this.acceleration:this.cursors.down.isDown?this.body.acceleration.y=this.acceleration:this.body.acceleration.y=0},self.Player.prototype.isAttacking=function(){return this.game.input.keyboard.isDown(Phaser.Keyboard.SPACEBAR)}}]),app.service("WeaponService",["$http","LoaderService","MessageService",function($http,LoaderService,MessageService){function init(){$http.get("/api/weapons").success(function(data){allWeaponData=data.allWeaponData,allWeapons=formatWeapons(allWeaponData),LoaderService.weapon=!0,LoaderService.loadHandler()}).error(function(data){MessageService.setFlashMessage(data.message,!0)})}function formatWeapons(allWeaponData){var weapons={};for(var playerClass in allWeaponData)if(allWeaponData.hasOwnProperty(playerClass)){var levelGroup=allWeaponData[playerClass];for(var level in levelGroup)if(levelGroup.hasOwnProperty(level)){var rarityGroup=levelGroup[level];for(var rarity in rarityGroup)if(rarityGroup.hasOwnProperty(rarity)){var weaponGroup=rarityGroup[rarity];for(var weapon in weaponGroup)weaponGroup.hasOwnProperty(weapon)&&(weapons[weapon]=weaponGroup[weapon])}}}return weapons}var allWeaponData,self=this,allWeapons={};self.getAllWeapons=function(){return allWeapons},self.getWeapon=function(key){return allWeapons[key]},self.getRarities=function(){return["Common","Rare","Legendary"]},init(),self.saveWeapon=function(weaponData){var weaponGroup;try{if(weaponGroup=allWeaponData[weaponData["class"]][weaponData.level][weaponData.rarity],weaponGroup.hasOwnProperty(weaponData.name)){var overwrite=confirm("There is already a LV "+weaponData.level+" "+weaponData["class"]+' weapon called "'+weaponData.name+'." Do you want to overwrite this weapon?');if(!overwrite)return void MessageService.setFlashMessage("Weapon was not saved.",!0)}}catch(err){console.log(err)}$http.post("../api/save/weapons",weaponData).success(function(data){MessageService.setFlashMessage(data.message,!1),allWeaponData=data.allWeaponData,allWeapons=formatWeapons(allWeaponData)}).error(function(data){MessageService.setFlashMessage(data.message,!0)})},self.getLoot=function(playerLevel,playerClass){for(var rngesus,rarity,level,loot=[],safety=0;loot.length<5;){if(safety++>=100)return[];rngesus=Math.random(),rarity="Common",.1>=rngesus?rarity="Legendary":.5>=rngesus&&(rarity="Rare");var levelOffset=Math.floor(3*Math.random()),upOrDown=Math.random()>.5?-1:1;level=playerLevel+levelOffset*upOrDown,1>level&&(level=1),level>30&&(level=30);var weapon,weaponGroup,levelGroup=allWeaponData[playerClass][level];if(levelGroup&&(weaponGroup=levelGroup[rarity]),weaponGroup){var keys=Object.keys(weaponGroup);weapon=weaponGroup[keys[keys.length*Math.random()<<0]],loot.push(weapon)}}return loot};var Bullet=function(game,key){Phaser.Sprite.call(this,game,0,0,key),this.animations.add("fly"),this.texture.baseTexture.scaleMode=PIXI.scaleModes.NEAREST,this.anchor.set(.5),game.physics.enable(this,Phaser.Physics.ARCADE),this.checkWorldBounds=!0,this.outOfBoundsKill=!0,this.exists=!1,this.tracking=!1,this.scaleSpeed=0};Bullet.prototype=Object.create(Phaser.Sprite.prototype),Bullet.prototype.constructor=self.Bullet,Bullet.prototype.fire=function(x,y,angle,speed,gx,gy){gx=gx||0,gy=gy||0,this.reset(x,y),this.scale.set(1),this.game.physics.arcade.velocityFromAngle(angle,speed,this.body.velocity),this.angle=angle,this.body.gravity.set(gx,gy),this.animations.play("fly",10,!0)},Bullet.prototype.update=function(){this.tracking&&(this.rotation=Math.atan2(this.body.velocity.y,this.body.velocity.x)),this.scaleSpeed>0&&(this.scale.x+=this.scaleSpeed,this.scale.y+=this.scaleSpeed)};var firePatterns={};firePatterns.SingleBullet={create:function(game,weaponData,damage){game.allPlayerBullets=game.add.group(),this.nextFire=0,this.bulletSpeed=600,this.fireRate=200;for(var i=0;64>i;i++){var bullet=game.allPlayerBullets.add(new Bullet(game,weaponData.spritesheet.key));bullet.damage=damage}},fire:function(game,source){if(!(game.time.time<this.nextFire)){var x=source.x+10,y=source.y+10;game.allPlayerBullets.getFirstExists(!1).fire(x,y,0,this.bulletSpeed,0,0),this.nextFire=game.time.time+this.fireRate}}},firePatterns.Radius={create:function(game,weaponData,damage){game.allPlayerBullets=game.add.group(),this.nextFire=0,this.bulletSpeed=600,this.fireRate=200;for(var i=0;96>i;i++){var bullet=game.allPlayerBullets.add(new Bullet(game,weaponData.spritesheet.key));bullet.damage=damage}},fire:function(game,source){if(!(game.time.time<this.nextFire)){for(var x=source.x+10,y=source.y+10,i=0;8>i;i++)game.allPlayerBullets.getFirstExists(!1).fire(x,y,45*i,this.bulletSpeed,0,0);this.nextFire=game.time.time+this.fireRate}}},self.getFirePatterns=function(){return firePatterns},self.getFirePattern=function(key){return firePatterns[key]}}]),app.controller("GameController",["AssetService","BossService","DamageService","EnemyService","LevelService","LoaderService","PersistenceService","PlayerService","WeaponService",function(AssetService,BossService,DamageService,EnemyService,LevelService,LoaderService,PersistenceService,PlayerService,WeaponService){LoaderService.addLoaderFunction(function(){function spawnEnemy(state){if(!state.bossSpawned){var col=state.levelData.enemies[state.levelCol];if(col){if(!state.pendingNextLevel){for(var i=0;i<col.length;i++){var enemyData=EnemyService.getEnemy(col[i]);if(enemyData){var enemy=new EnemyService.Enemy(game,game.width,0,enemyData,state.player);enemy.y=50*i+enemy.height/2,game.enemyGroup.add(enemy)}}state.levelCol++}}else{state.bossSpawned=!0;var boss=new BossService.Biscione(game,game.width-350,250);boss.events.onDestroy.add(function(){game.time.events.add(5e3,function(){var fadeout=game.add.tween(game.tiles).to({alpha:0},500,"Linear",!0,0);fadeout.onComplete.add(function(){game.time.events.add(1e3,function(){game.state.start("loot")})})})}),game.enemyGroup.add(boss)}}}var gameplayState={preload:function(){game.load.script("webfont","//ajax.googleapis.com/ajax/libs/webfont/1/webfont.js"),game.load.spritesheet("death","../api/uploads/explode.png",50,50),game.load.image("shadow","../api/uploads/shadow.png"),game.load.image("cursor","assets/cursor.png"),BossService.preloadBossAssets(game),AssetService.preloadAllAssets(game)},create:function(){var scrollSpeed=-100;this.enemyTimer=0,this.levelData=PersistenceService.getCurrentLevel(game),this.levelCol=0,this.bossSpawned=!1,game.layers={background:game.add.group(),shadows:game.add.group(),player:game.add.group(),enemies:game.add.group(),fx:game.add.group(),ui:game.add.group()},game.tiles=game.add.tileSprite(0,0,game.width,game.height,this.levelData.background.key),game.tiles.autoScroll(scrollSpeed,0),game.layers.background.add(game.tiles),game.deathAnimations=game.add.group();for(var i=0;10>i;i++){var deathSpr=game.add.sprite(0,0,"death");deathSpr.animations.add("die"),deathSpr.anchor.setTo(.5,.5),deathSpr.kill(),game.deathAnimations.add(deathSpr)}game.physics.enable(game.deathAnimations,Phaser.Physics.ARCADE);var playerData=PersistenceService.getPlayerData(),weaponData=PersistenceService.getCurrentWeapon();for(this.player=new PlayerService.Player(game,50,game.world.centerY,playerData,weaponData),game.allEnemyBullets=game.add.group(),game.enemyGroup=game.add.group(),game.layers.enemies.add(game.enemyGroup),game.damageNums=game.add.group(),i=0;99>i;i++){var dmgText=game.add.bitmapText(0,0,"carrier_command","",12);dmgText.anchor.setTo(.5,.5),dmgText.kill(),game.damageNums.add(dmgText)}game.layers.ui.add(game.damageNums)},update:function(){this.enemyTimer++,this.enemyTimer%20===0&&spawnEnemy(this),game.physics.arcade.overlap(game.enemyGroup,game.allPlayerBullets,hitEnemyByBulletHandler);for(var i=0;i<game.allEnemyBullets.children.length;i++)subgroup=game.allEnemyBullets.children[i],game.physics.arcade.overlap(this.player,subgroup,hitPlayerByBulletHandler,hitPlayerProcess);game.physics.arcade.overlap(this.player,game.enemyGroup,hitPlayerByEnemyHandler,hitPlayerProcess),game.physics.arcade.collide(game.enemyGroup)}},hitPlayerProcess=function(player){return!player.invincible},hitEnemyByBulletHandler=function(enemy,bullet){bullet.kill(),DamageService.takeDamage(enemy,1)},hitPlayerByBulletHandler=function(player,bullet){bullet.kill(),DamageService.takeDamage(player,bullet.damage,!0)},hitPlayerByEnemyHandler=function(player,enemy){DamageService.takeDamage(player,enemy.damage,!0)},bootState={preload:function(){game.load.spritesheet("load-ghost","assets/load-ghost.png",24,36),game.load.bitmapFont("carrier_command","assets/carrier_command.png","assets/carrier_command.xml")},create:function(){game.physics.startSystem(Phaser.Physics.ARCADE),game.state.start("load")}},loadState={preload:function(){var loadSprite=game.add.sprite(game.world.centerX,game.world.centerY-45,"load-ghost");loadSprite.anchor.setTo(.5,.5),loadSprite.animations.add("move",[0,1,2,3,4],10,!0),loadSprite.animations.play("move"),this.loadingText=game.add.bitmapText(game.world.centerX,game.world.centerY,"carrier_command","LOADING",14),this.loadingText.anchor.setTo(.5,.5),this.textTimer=0,this.tochki=0,this.minLoadscreenTime=100,AssetService.preloadAllAssets(game)},update:function(){if(this.textTimer++,this.textTimer%25===0){this.tochki++,this.tochki=this.tochki>3?0:this.tochki,this.loadingText.text="LOADING";for(var i=0;i<this.tochki;i++)this.loadingText.text+="."}this.textTimer>=this.minLoadscreenTime&&game.state.start("mainMenu")}},mainMenuState={create:function(){var menuText=game.add.bitmapText(game.world.centerX,game.world.centerY,"carrier_command","Trace Italienne",32);menuText.anchor.setTo(.5,.5);var startText=game.add.bitmapText(game.world.centerX,game.world.height-32,"carrier_command","Press 'SPACE' to start",14);startText.anchor.setTo(.5,.5),startText.alpha=0,this.startTween=game.add.tween(startText).to({alpha:1},380,"Linear",!0,0,-1,!0),this.space=game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR),this.prevSpace=!1},update:function(){this.space.isDown&&!this.prevSpace&&(this.prevSpace=!0,this.startTween.timeScale=5,game.time.events.add(800,function(){game.state.start("prelevel")}))}},prelevelState={create:function(){var levelData=PersistenceService.getCurrentLevel(game),scrollSpeed=-100;this.bg=game.add.tileSprite(0,0,game.width,game.height,levelData.background.key),this.bg.autoScroll(scrollSpeed,0);var levelText="Level "+levelData.number+": "+levelData.title,title=game.add.bitmapText(game.world.centerX,game.world.centerY-64,"carrier_command",levelText,32);title.anchor.setTo(.5,.5);var description=game.add.bitmapText(game.world.centerX,game.world.centerY+64,"carrier_command",levelData.description,14);description.anchor.setTo(.5,.5);var startText=game.add.bitmapText(game.world.centerX,game.world.height-32,"carrier_command","Press 'SPACE' to start",14);startText.anchor.setTo(.5,.5),startText.alpha=0,this.startTween=game.add.tween(startText).to({alpha:1},380,"Linear",!0,0,-1,!0),this.space=game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR),this.prevSpace=!1},update:function(){if(this.space.isDown&&!this.prevSpace){this.prevSpace=!0,this.bg.autoScroll(0,0),this.startTween.timeScale=5;var bgTween=game.add.tween(this.bg).to({alpha:0},500,"Linear",!0,0);bgTween.onComplete.add(function(){game.time.events.add(500,function(){game.state.start("gameplay")},this)},this)}}},lootState={create:function(){function updateList(){for(var text="-- LOOT --\n\n",i=0;i<loot.length;i++)text+=loot[i].name,i===currentChoice&&(text+=" - equipped"),text+="\n\n";return text}function updateInfo(){var text="-- equipped --\n\n",weapon=loot[currentChoice];return text+="Name: "+weapon.name+"\n\n",text+="Rarity: "+weapon.rarity+"\n\n",text+="Required LV: "+weapon.level+"\n\n",text+="Damage: "+weapon.damageBoost+"\n\n",text+="Attack Type: "+weapon.firePattern+"\n\n"}game.add.bitmapText(game.world.centerX,32,"carrier_command","You found weapons!",32).anchor.setTo(.5,.5);var instruct=game.add.bitmapText(game.world.centerX,64,"carrier_command","Press SPACE to equip a weapon or ENTER to start the next level",8);instruct.anchor.setTo(.5,.5);var instructTween=game.add.tween(instruct).to({alpha:.3},500,"Linear",!0,0,-1,!0),playerData=PersistenceService.getPlayerData(),weaponData=PersistenceService.getCurrentWeapon(),player=new PlayerService.Player(game,game.world.centerX,game.world.centerY,playerData,weaponData);player.update=function(){this.animations.play("move"),this.weapon.fire(game,this)};var loot=WeaponService.getLoot(playerData.level,playerData.name);loot.unshift(weaponData);var currentChoice=0,weaponsList=game.add.bitmapText(22,game.world.height-8,"carrier_command",updateList(),8);weaponsList.anchor.setTo(0,1);var cursor=game.add.sprite(14,weaponsList.y-weaponsList.height+11,"cursor");cursor.anchor.set(.5);var startPos=cursor.y;game.add.tween(cursor).to({alpha:0},100,"Linear",!0,0,-1,!0);var up=game.input.keyboard.addKey(Phaser.Keyboard.UP),down=game.input.keyboard.addKey(Phaser.Keyboard.DOWN),enter=game.input.keyboard.addKey(Phaser.Keyboard.ENTER),space=game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);up.onDown.add(function(){currentChoice--,0>currentChoice&&(currentChoice=loot.length-1),cursor.y=startPos+16*currentChoice}),down.onDown.add(function(){currentChoice++,currentChoice>loot.length-1&&(currentChoice=0),cursor.y=startPos+16*currentChoice}),enter.onDown.add(function(){instructTween.timeScale=5,game.time.events.add(800,function(){console.log(PersistenceService),PersistenceService.nextLevel(game)},this)});var weaponInfoText=game.add.bitmapText(game.width/3*2,game.world.height-24,"carrier_command",updateInfo(),8);weaponInfoText.anchor.setTo(0,1),weaponInfoText.maxWidth=game.width/3,space.onDown.add(function(){weaponData=loot[currentChoice],PersistenceService.setCurrentWeapon(weaponData),player.pendingDestroy=!0,player=new PlayerService.Player(game,game.world.centerX,game.world.centerY,playerData,weaponData),player.update=function(){this.animations.play("move"),this.weapon.fire(game,this)},weaponInfoText.text=updateInfo(),weaponsList.text=updateList()})}},loseState={create:function(){game.add.tween(game.world).to({alpha:1},500,"Linear",!0),game.add.bitmapText(game.world.centerX,game.world.centerY,"carrier_command","You died",32).anchor.setTo(.5,.5);var retry=game.add.bitmapText(game.world.centerX,game.world.centerY+96,"carrier_command","Retry",14);retry.anchor.setTo(.5,.5);var quit=game.add.bitmapText(game.world.centerX,game.world.centerY+124,"carrier_command","Main Menu",14);quit.anchor.setTo(.5,0);var cursor=game.add.sprite(game.world.centerX-96,game.world.centerY+96,"cursor");cursor.anchor.setTo(.5,.5);var startPos=cursor.y,currentChoice=0,selected=!1,up=game.input.keyboard.addKey(Phaser.Keyboard.UP),down=game.input.keyboard.addKey(Phaser.Keyboard.DOWN),enter=game.input.keyboard.addKey(Phaser.Keyboard.ENTER),space=game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);up.onDown.add(function(){selected||(currentChoice--,0>currentChoice&&(currentChoice=1),cursor.y=startPos+36*currentChoice)}),down.onDown.add(function(){selected||(currentChoice++,currentChoice>1&&(currentChoice=0),cursor.y=startPos+36*currentChoice)});var onChoice=function(){selected||(selected=!0,0===currentChoice?(game.add.tween(retry).to({alpha:0},80,"Linear",!0,0,-1,!0),game.time.events.add(800,function(){game.state.start("prelevel")})):(game.add.tween(quit).to({alpha:0},80,"Linear",!0,0,-1,!0),game.time.events.add(800,function(){game.state.start("mainMenu")})))};enter.onDown.add(onChoice),space.onDown.add(onChoice)}},winState={create:function(){var menuText=game.add.bitmapText(game.world.centerX,game.world.centerY,"carrier_command","You win!",32);menuText.anchor.setTo(.5,.5);var otherText=game.add.bitmapText(game.world.centerX,game.world.centerY+64,"carrier_command","This is where we would show end game stats, credits, etc.",14);otherText.anchor.setTo(.5,.5);var startText=game.add.bitmapText(game.world.centerX,game.world.height-32,"carrier_command","Press 'SPACE' to go back to main menu",14);startText.anchor.setTo(.5,.5),startText.alpha=0,this.startTween=game.add.tween(startText).to({alpha:1},380,"Linear",!0,0,-1,!0),this.space=game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR),this.prevSpace=!1},update:function(){this.space.isDown&&!this.prevSpace&&(this.prevSpace=!0,this.startTween.timeScale=5,game.time.events.add(500,function(){game.state.start("mainMenu")}))}},game=new Phaser.Game(1e3,500,Phaser.CANVAS,"phaser-frame");game.state.add("boot",bootState),game.state.add("load",loadState),game.state.add("mainMenu",mainMenuState),game.state.add("prelevel",prelevelState),game.state.add("gameplay",gameplayState),game.state.add("loot",lootState),game.state.add("lose",loseState),game.state.add("win",winState),game.state.start("boot")})}]);